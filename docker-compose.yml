name: erp

services:
  # =========================================
  # FRONTEND - React + Nginx (V2 - Enero 2026)
  # =========================================
  # Incluye: Sistema SCSS, i18n, nuevos módulos de pagos,
  # inventario mejorado, sistema de monedas
  erp-system:
    image: erp-frontend:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: erp-system
    ports:
      - "8080:80"
      - "8443:443" # Si usas HTTPS
    environment:
      # Las variables de entorno se toman de .env.production
      # durante el build, no en runtime
      - NODE_ENV=production
      - TZ=America/Asuncion  # Ajustar según tu zona horaria
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - erp-network
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      # Opcional: logs de Nginx
      - ./logs/nginx:/var/log/nginx
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =========================================
  # BACKEND - API (V2 - Enero 2026)
  # =========================================
  # Incluye actualizaciones importantes de pagos, inventario,
  # y nuevas funcionalidades
  backend:
    image: erp-backend:latest
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: erp-backend
    ports:
      - "5050:5050"
    environment:
      - PORT=:5050
      - JWT_SECRET=pwdUltraSecreta
      - TZ=America/Asuncion  # Ajustar según tu zona horaria
      # Conexión a PostgreSQL en Windows host
      # host.docker.internal apunta al host de Windows desde el contenedor
      - DATABASE_URL=host=host.docker.internal port=5432 user=dev_user password=aDmin404942 dbname=erp_db sslmode=disable
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=dev_user
      - DB_PASSWORD=aDmin404942
      - DB_NAME=erp_db
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - erp-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5050/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  erp-network:
    driver: bridge

# =========================================
# VOLÚMENES (opcional)
# =========================================
volumes:
  nginx-logs:
    driver: local
